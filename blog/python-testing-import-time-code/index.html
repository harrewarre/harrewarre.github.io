<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>harre.dev | Testing Python code that runs during import</title>
    <link rel="stylesheet" href="/assets/style/theme.css">
    <link rel="stylesheet" href="/assets/style/prism-okaidia.css">
    <link rel="icon" type="image/png" href="/assets/favicon.png">
  </head>
  <body>
    <main>
    <header>
      <h1>
        <a href="/">harre.dev</a>
      </h1>
    </header>
    <nav>
      <a href="/">home</a>
      <a href="/blog">blog</a>
      <a href="/about">about</a>
      <a href="https://hachyderm.io/@harre" rel="me">me</a>
      <a href="/feed.xml">rss</a>
    </nav>
      
<article>
    <div class="post-date">2024-08-19 </div>
    <h1>Testing Python code that runs during import</h1>
<p>I've been pretty comfortable with Python after making the switch from dotnet core to Python for a new client.</p>
<p>During this time I've gotten to know the way around the ecosystem and Python-isms, but sometimes I run into something that makes me go &quot;huh? oh...&quot;.
This post describes one such moment.</p>
<h2>Modules</h2>
<p>So in Python modules can use each others functionality by importing them into one another using the <code>import</code> keyword and referencing the module you want to use e.g:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os</code></pre>
<p>Let's dive in, I was setting up a <a href="https://pypi.org/project/dependency-injector/">dependency container to leverage dependency injection</a> in Python to make the composition of the final app more flexible and keep all the classes in the modules testable through inversion of control.</p>
<p>Here's the container (simplified for the sake of this post):</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> dependency_injector <span class="token keyword">import</span> containers<span class="token punctuation">,</span> providers

<span class="token keyword">from</span> dep <span class="token keyword">import</span> Dependency

<span class="token keyword">class</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>containers<span class="token punctuation">.</span>DeclarativeContainer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> providers<span class="token punctuation">.</span>Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>client_id<span class="token punctuation">.</span>from_env<span class="token punctuation">(</span><span class="token string">"CLIENT_ID"</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    config<span class="token punctuation">.</span>working_directory<span class="token punctuation">.</span>from_env<span class="token punctuation">(</span><span class="token string">"WORKING_DIRECTORY"</span><span class="token punctuation">,</span> default<span class="token operator">=</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  

    some_dependency <span class="token operator">=</span> providers<span class="token punctuation">.</span>Singleton<span class="token punctuation">(</span>Dependency<span class="token punctuation">,</span> config<span class="token punctuation">.</span>working_directory<span class="token punctuation">,</span> config<span class="token punctuation">.</span>tenant_id<span class="token punctuation">)</span>  </code></pre>
<p>Instantiation of this container happens as soon as the app is started to get access to all the registered dependencies. It also holds some configuration that is read from the environment (see <a href="https://12factor.net/config">12-factor apps configuration</a>).</p>
<p>I generally skip testing of this kind of code since it's all glue between the various dependencies but as I put in the <code>required=True</code> on the <code>client_id</code> I thought: I might want to capture this behavior somewhere so that I'll know when I mess with something the future.
So, in come the tests, maybe not <em>test-first</em> this time, but I still wanted to put some guardrails around this type of initialization code.</p>
<p>I wrote the tests one by one and all was fine, until I ran the tests one single session, only the first one passed! Wat?</p>
<h2>The tests</h2>
<p>Here's the final result with the &quot;Today I Learned&quot; moment explained:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os  
<span class="token keyword">import</span> sys  
<span class="token keyword">import</span> unittest  
<span class="token keyword">from</span> unittest <span class="token keyword">import</span> mock  
  
  
<span class="token keyword">class</span> <span class="token class-name">ContainerTest</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token comment"># The container initialization happens at import time, so we need wipe any existing  </span>
        <span class="token comment"># imports for application.container. The container uses from_env during import</span>
        <span class="token comment"># which we work around by importing the container again for each test.</span>
        <span class="token keyword">if</span> <span class="token string">"application.container"</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">:</span>  
            <span class="token keyword">del</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">"application.container"</span><span class="token punctuation">]</span>  
  
    <span class="token decorator annotation punctuation">@mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span>dict</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"CLIENT_ID"</span><span class="token punctuation">:</span> <span class="token string">"test-client"</span><span class="token punctuation">,</span> <span class="token string">"WORKING_DIRECTORY"</span><span class="token punctuation">:</span> <span class="token string">"/some/root/path"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> clear<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    <span class="token keyword">def</span> <span class="token function">test_it_should_initialize_container</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">from</span> application<span class="token punctuation">.</span>container <span class="token keyword">import</span> Container  
        container <span class="token operator">=</span> Container<span class="token punctuation">(</span><span class="token punctuation">)</span>  
  
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span><span class="token string">"test-client"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tenant_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span><span class="token string">"/some/root/path"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>config<span class="token punctuation">.</span>working_directory<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
  
    <span class="token decorator annotation punctuation">@mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span>dict</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"WORKING_DIRECTORY"</span><span class="token punctuation">:</span> <span class="token string">"/some/root/path"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> clear<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    <span class="token keyword">def</span> <span class="token function">test_it_should_not_initialize_container_without_tenant_variable</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">with</span> self<span class="token punctuation">.</span>assertRaises<span class="token punctuation">(</span>ValueError<span class="token punctuation">)</span> <span class="token keyword">as</span> ve<span class="token punctuation">:</span>  
            <span class="token keyword">from</span> application<span class="token punctuation">.</span>container <span class="token keyword">import</span> Container  
            _ <span class="token operator">=</span> Container<span class="token punctuation">(</span><span class="token punctuation">)</span>  
  
        exception <span class="token operator">=</span> ve<span class="token punctuation">.</span>exception  
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span><span class="token string">'Environment variable "CLIENT_ID" is undefined'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>  
  
    <span class="token decorator annotation punctuation">@mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span>dict</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"CLIENT_ID"</span><span class="token punctuation">:</span> <span class="token string">"test-client"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> clear<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    <span class="token keyword">def</span> <span class="token function">test_it_should_initialize_container_with_default_policy_sets_root_path</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">from</span> application<span class="token punctuation">.</span>container <span class="token keyword">import</span> Container  
        container <span class="token operator">=</span> Container<span class="token punctuation">(</span><span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>config<span class="token punctuation">.</span>working_directory<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>The clue is in the comments already, but here's the full details. When I started writing my tests I imported the container at the top of the file:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> application<span class="token punctuation">.</span>container <span class="token keyword">import</span> Container</code></pre>
<p>This made each individual test pass in isolation but not all together in a single run... What's the deal? I mistakenly assumed that those declarations inside the container's <code>class</code> would happen at the moment the container was constructed (<code>container = Container()</code>) but this is not the case.</p>
<p>In my assumption I mixed up <strong>instance</strong> level attributes (those that operate at instance creation) and <strong>class</strong> attributes (these run when the container code is imported!). Which in the case of the container makes sense, we want those dependencies to be constant.</p>
<p>This also explains why the tests kept failing when running in a single session. <strong>The import only took place once</strong>! As soon as the container code was imported, its state (those environment variables and other dependencies) was locked in and would not change from one test to the next. The other tests after it would fail due to the container's unexpected state.</p>
<h2>The solution</h2>
<p>Ok, then how do you get around this? Well I learned that you can remove modules that have already been imported and then... Import them again! Precisely what I need. Python keeps track of all <a href="https://docs.python.org/3/library/sys.html#sys.modules">the modules that have been loaded</a> in a special list in <code>sys.modules</code>. Turns out you can also remove modules from this list. It does come with a word of caution about its use though:</p>
<p><code>sys.modules</code>:</p>
<blockquote>
<p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. If you want to iterate over this global dictionary always use sys.modules.copy() or tuple(sys.modules) to avoid exceptions as its size may change during iteration as a side effect of code or activity in other threads.</p>
</blockquote>
<p>Not really something you would use in your every day Python code I think, but these are tests, so we are in a well known state for each of the test modules and we should be fine.</p>
<p>To unload a module you can delete it from the list using the module's name:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">del</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">"application.container"</span><span class="token punctuation">]</span></code></pre>
<p>Since we are running more than one test, we need to unload the container module before each one. This can be achieved using Python <code>unittest</code>'s <code>setUp</code> helper method. This method runs before each test and deletes the <code>application.container</code> module if it's present.
Each test preps its own conditions using mocks and can then decide at what point the container code should get imported, and we can successfully assert the behavior we expect from it.</p>
<p>While <code>sys.modules</code> does come with a little disclaimer about unpredictable behavior, code that runs during import (instead of instantiation) can now be tested without running into unpredictable state issues in your own code.</p>
<p>Happy coding!</p>

    <div class="tags">
        
            python
        
            testing
        
            tdd
        
    </div>
</article>

    <footer>
      <p>Â© 2025 harre.dev</p>
    </footer>
    </main>
  </body>
</html>
